# CPU设计说明

## CPU设计概述

CPU具有如下特点：

- 实现100条指令、18个CP0寄存器、12种例外，兼容MIPS32 Release 1
- 32项TLB，提供可变页大小支持
- 内核模式/用户模式的支持
- 高主频、高吞吐静态单发射流水线设计，连接cache时可工作于100MHz频率，理想情况下IPC可达1

## 流水线功能设计

CPU采用静态单发射流水线结构，流水线分为取指（IF）、译码（ID）、执行（EX）、写回（WB）四级。区别于传统的五级流水结构，我们的设计中将执行和访存两级合并为执行一级，这样做出于如下考虑：

- 虽然从理论上讲，流水线级数越多，可以获得的主频越高，但我们在实践中发现，在每一级都可能产生阻塞的情况下，要实现高效流水，需要有贯穿整个流水线的控制信号进行阻塞控制，而这一路径的延迟随流水级数的增加而增大。且对于大多数指令，仅需一级即可完成对应操作，使用执行和访存两级显得不太必要，因此采用了四级流水设计。

- 指令间相关性随流水级数增加而增大。这体现在前递逻辑增加、额外的HI/LO寄存器相关和CP0相关。同时，例外处理的清空流水线逻辑也会相应增加。

### PC寄存器

PC寄存器位于IF级之前，提供取指的目标地址。由于分支目标会旁路（bypass）PC寄存器，真正传入IF的地址if_pc是二者选择的结果。PC寄存器每拍更新，在例外提交时载入例外向量，其他情况下，若IF接收了取指地址，PC载入if_pc+4,否则载入if_pc。

### 取指（IF）

根据传入的取指地址，在进行地址检查、TLB转换后发出取指请求，当请求被外部响应，该级的内容被传递至ID级。由于TLB查询逻辑路径长，查询过程被分为多拍，由状态机进行控制。为尽可能提升速度，查询的结果会被缓存，若本次请求的虚拟地址与上次请求的高20位相同（TLB支持的最小页大小为4KB），直接采用上次查询结果的高20位作为物理地址，这样缓存命中时这个请求过程可在一拍内完成。

### 译码（ID）

接收外部返回的指令并译码，根据指令中的寄存器号读相应寄存器或接受前递数据。由于从cache返回路径较长，ID级的译码仅译出对应指令，控制信号生成放在EX级进行。

### 执行（EX）

根据ID级传入的信息，完成剩余的控制信号生成工作。所有计算型指令、控制转移指令、CP0指令以及访存指令的请求发出均在EX级完成。中断信号在这一级处理，所有例外汇总到EX级提交。

### 写回（WB）

访存指令在WB级接收回应；写寄存器的指令在WB级进行写回。

## 流水线级间设计

### 握手信号

流水线上下级之间通过一组valid/ready信号握手，以传递有效信号和实现阻塞控制。

```
|----|         |----|         |----|         |----|
|    |--valid->|    |--valid->|    |--valid->|    |
| IF |         | ID |         | EX |         | WB |
|    |<-ready--|    |<-ready--|    |<-ready--|    |
|----|         |----|         |----|         |----|
```

valid表示来自上一级的指令是有效指令，ready表示下一级可以接收指令。当一对valid/ready信号同时有效时，有效指令从上一级传递给下一级。

### 前递处理

前递的数据路径如下（注意级间寄存器位于上级的模块中，这里为了方便分离了出来）：

```
|----|    |-----|    |----|    |-----|    |----|
|    |    |     |    |    |    |     |    |    |
|    |    |     |    |    |    |     |    |    |
| ID |--->|ID/EX|----| EX |--->|EX/WB|----| WB |--->(reg_file)
|    |    |     |    |    | |  |     |    |    | |
|    |    |     |    |    | |  |     |    |    | |
|----|    |-----|    |----| |  |-----|    |----| |
   |                        |                    |
|-----------|               |                    |
|  Forward  |---------------'                    |
|  Process  |------------------------------------'
|-----------|
```

### 例外处理

例外传递路径如下：

```
                                       interrupt commit
                                             |     ^
|----|    |-----|    |----|    |-----|    |----|   |
|    |    |     |    |    |    |     |    |    |   |
|    |    |     |    |    |    |     |    |    |   |
| IF |--->|IF/ID|----| ID |--->|ID/EX|----| EX |---'
|    |    |     |    |    |    |     |    |    |
|    |    |     |    |    |    |     |    |    |
|----|    |-----|    |----|    |-----|    |----|
```

由于WB级不会发生例外，例外提交在EX级之后进行。事实上只有IF和EX级会产生例外。

例外取消路径如下：

```
|----|    |-----|    |----|    |-----|    |----|
|    |    |     |    |    |    |     |    |    |
|    |    |     |    |    |    |     |    |    |
| IF |    |IF/ID|    | ID |    |ID/EX|    | EX |
|    |    |     |    |    |    |     |    |    |
|    |    |     |    |    |    |     |    |    |
|----|    |-----|    |----|    |-----|    |----|
    ^                    ^                 |
    |                    |cancel_i   commit|
    |                    |                 |
    |                    `-----------------|
    |                                      |
    `--------------------------------------'
```